// MERP 2nd Edition - Attack Tables (AT-1 through AT-9)
// Format: Each row is [minRoll, maxRoll, plate, chain, rigidLeather, softLeather, none]
// Values: number = hits only, "XY" = hits + critical (e.g. "7A" = 7 hits + A critical)
// "F" = fumble, 0 = miss/no effect
// UM rows have fumble potential

// Helper: parse attack result string into {hits, crit}
MERP.parseAttackResult = function(val) {
    if (val === "F") return { hits: 0, crit: null, fumble: true };
    if (typeof val === "number") return { hits: val, crit: null, fumble: false };
    if (typeof val === "string") {
        const match = val.match(/^(\d+)([A-E])$/);
        if (match) return { hits: parseInt(match[1]), crit: match[2], fumble: false };
        // Try "F" embedded
        if (val === "F") return { hits: 0, crit: null, fumble: true };
    }
    return { hits: 0, crit: null, fumble: false };
};

// AT-1: 1-Handed Slashing Weapons
MERP.AT1 = [
    // [minRoll, maxRoll, plate, chain, rigidLeather, softLeather, none]
    // UM = Unmodified 01-08: possible fumble
    [1, 8, "F", "F", "F", "F", "F"],  // UM range
    [9, 45, 0, 0, 0, 0, 0],
    [46, 50, 1, 0, 0, 0, 0],
    [51, 55, 1, 1, 0, 0, 0],
    [56, 60, 2, 1, 0, 0, 0],
    [61, 65, 2, 2, 0, 0, 0],
    [66, 70, 3, 3, 2, 3, 0],
    [71, 75, 3, 4, 3, 3, 5],
    [76, 80, 4, 5, 5, "7A", 7],
    [81, 85, 5, 6, 6, "9A", "9A"],
    [86, 90, 5, 7, "7A", "10B", "10A"],
    [91, 95, 6, 8, "9A", "12B", "11B"],
    [96, 100, 6, 9, "10B", "13B", "13C"],
    [101, 105, 7, "10A", "11B", "13C", "15C"],
    [106, 110, "8A", "12B", "13C", "17C", "17D"],
    [111, 115, "8A", "12B", "13C", "15C", "17D"],
    [116, 120, "9A", "13B", "15C", "18D", "20D"],
    [121, 125, "9A", "13C", "16C", "19D", "21E"],
    [126, 130, "10B", "14C", "17D", "20D", "23E"],
    [131, 135, "11B", "15C", "18D", "22D", "25E"],
    [136, 140, "11C", "16D", "20D", "23E", "27E"],
    [141, 145, "12D", "17D", "21E", "24E", "28E"],
    [146, 150, "12E", "18E", "22E", "25E", "30E"]
];

// AT-2: 1-Handed Concussion Weapons
MERP.AT2 = [
    [1, 8, "F", "F", "F", "F", "F"],
    [9, 30, 0, 0, 0, 0, 0],
    [31, 40, 1, 0, 0, 0, 0],
    [41, 45, 1, 1, 0, 0, 0],
    [46, 50, 2, 2, 0, 0, 0],
    [51, 55, 3, 3, 3, 0, 0],
    [56, 60, 3, 4, 0, 0, 0],
    [61, 65, 4, 5, 0, 0, 0],
    [66, 70, 5, 6, 2, 3, 0],
    [71, 75, 5, 7, 3, 5, 0],
    [76, 80, 6, "B", 4, 6, 0],
    [81, 85, 7, 9, 6, "7A", 6],
    [86, 90, 8, 11, "8A", "9A", "9A"],
    [91, 95, 8, 11, "8A", "9A", "9A"],
    [96, 100, 9, "12A", "9B", "10B", "10B"],
    [101, 105, 10, "13A", "10B", "11B", "12C"],
    [106, 110, "10A", "14B", "11B", "12B", "13C"],
    [111, 115, "11A", "15B", "12C", "13C", "14C"],
    [116, 120, "11B", "16C", "13C", "14C", "15D"],
    [121, 125, "12B", "17C", "14C", "19D", "21E"],
    [126, 130, "13B", "18C", "16C", "19D", "21E"],
    [131, 135, "14C", "19D", "17D", "19E", "23E"],
    [136, 140, "15D", "20D", "18D", "20E", "25E"],
    [141, 145, "16D", "21E", "19E", "21E", "27E"],
    [146, 150, "16E", "22E", "20E", "22E", "28E"]
];

// AT-3: 2-Handed Weapons
MERP.AT3 = [
    [1, 8, "F", "F", "F", "F", "F"],
    [9, 55, 0, 0, 0, 0, 0],
    [56, 60, 2, 0, 0, 0, 0],
    [61, 65, 3, 0, 0, 0, 0],
    [66, 70, 4, 3, 0, 6, 0],
    [71, 75, 5, 5, 5, 2, "8A"],
    [76, 80, 6, 7, "4A", "10A", 0],
    [81, 85, 7, 9, "7A", "13B", "10A"],
    [86, 90, 8, 11, "9B", "15B", "13B"],
    [91, 95, 9, "12A", "12B", "17C", "16C"],
    [96, 100, "10A", "14A", "14C", "20C", "19D"],
    [101, 105, "12A", "14B", "16B", "22C", "22D"],
    [106, 110, "13A", "15B", "18B", "19C", "24D"],
    [111, 115, "14B", "20C", "22C", "27D", "28E"],
    [116, 120, "15B", "22C", "24C", "29D", "31E"],
    [121, 125, "16C", "24C", "24D", "29D", "33E"],
    [126, 130, "17C", "26D", "29D", "33E", "36E"],
    [131, 135, "19D", "28D", "32E", "36E", "39E"],
    [136, 140, "20D", "29E", "34E", "38E", "42E"],
    [141, 145, "21E", "31E", "37E", "40E", "45E"],
    [146, 150, "22E", "33E", "40E", "43E", "48E"]
];

// AT-4: Missile Weapons
MERP.AT4 = [
    [1, 8, "F", "F", "F", "F", "F"],
    [9, 70, 0, 0, 0, 0, 0],
    [71, 75, 1, 0, 0, 0, 0],
    [76, 80, 2, 2, 0, 4, 0],
    [81, 85, 3, 4, 3, 6, 0],
    [86, 90, 4, 6, 5, 5, "8A"],
    [91, 95, 5, 7, "7A", "10A", "8A"],
    [96, 100, 6, "8A", "9A", "12B", "10B"],
    [101, 105, 7, "10A", "10B", "13B", "11C"],
    [106, 110, "8A", "13B", "12B", "14B", "13C"],
    [111, 115, 9, "14B", "13B", "16C", "15C"],
    [116, 120, "10A", "16B", "15C", "17C", "16D"],
    [121, 125, "11B", "17C", "17C", "19D", "18D"],
    [126, 130, "12C", "20C", "21D", "21D", "20D"],
    [131, 135, "13C", "22D", "23E", "25E", "25E"],
    [136, 140, "14D", "23D", "23E", "25E", "23E"],
    [141, 145, "15E", "25E", "25E", "26E", "25E"],
    [146, 150, "15E", "25E", "25E", "26E", "27E"]
];

// AT-5: Tooth & Claw
MERP.AT5 = [
    [1, 8, "F", "F", "F", "F", "F"],
    [3, 45, 0, 0, 0, 0, 0],
    [46, 50, 0, 0, 0, 0, 1],
    [51, 55, 0, 0, 0, 0, 2],
    [56, 60, 1, 0, 0, 1, 4],
    [61, 65, 1, 1, 1, 2, "5T"],
    [66, 70, 2, 2, 2, 4, "6T"],
    [71, 75, 3, 3, 3, 5, "8T"],
    [76, 80, 4, 4, 5, "7T", "9A"],
    [81, 85, 5, 5, 5, "7T", "9T"],
    [86, 90, 6, "6T", "8T", "10A", "12A"],
    [91, 95, "6T", "7T", "9A", "11A", "13B"],
    [96, 100, "7T", "8A", "10A", "12A", "14B"],
    [101, 105, "7A", "9A", "11A", "13B", "15B"],
    [106, 110, "8A", "10A", "12B", "15B", "17C"],
    [111, 115, "9A", "10B", "13B", "16C", "19C"],
    [116, 120, "9B", "11B", "14C", "17C", "20D"],
    [121, 125, "14B", "15B", "18C", "20C", "26D"],
    [126, 130, "16B", "18C", "20C", "23D", "28E"],
    [131, 135, "18C", "20C", "22D", "25D", "30E"],
    [136, 140, "20C", "23D", "26D", "30E", "36E"],
    [141, 145, "22D", "25D", "29E", "33E", "38E"],
    [146, 150, "24E", "27E", "32E", "36E", "40E"]
];

// AT-6: Grappling & Unbalancing
MERP.AT6 = [
    [1, 8, "F", "F", "F", "F", "F"],
    [3, 55, 0, 0, 0, 0, 0],
    [56, 60, 1, 0, 0, 0, 0],
    [61, 65, 1, 0, 0, 0, 1],
    [66, 70, "2T", 1, 0, 1, 1],
    [71, 75, "2A", "2T", 1, 3, 2],
    [76, 80, "3A", "3T", 1, 2, "4T"],
    [81, 85, "3A", "4T", "4T", "6T", 5],
    [86, 90, "4A", "4A", "5T", "7T", "7T"],
    [91, 95, "4A", "5A", "6T", "8A", "8T"],
    [96, 100, "5B", "6A", "7A", "9A", "10T"],
    [101, 105, "5B", "7A", "7A", "10A", "11A"],
    [106, 110, "6C", "8B", "10A", "12B", "14A"],
    [111, 115, "7C", "9C", "10B", "13B", "15A"],
    [116, 120, "8C", "10C", "12B", "14C", "16B"],
    [121, 125, "10D", "11C", "14B", "16C", "18B"],
    [126, 130, "11D", "13D", "16C", "18C", "20B"],
    [131, 135, "12D", "15D", "18C", "20D", "22C"],
    [136, 140, "14E", "19D", "22C", "26D", "28C"],
    [141, 145, "16E", "21E", "25D", "28D", "30C"],
    [146, 150, "18E", "23E", "27E", "30E", "33D"]
];

// AT-7: Bolt Spells Attack Table
MERP.AT7 = [
    [1, 2, "F", "F", "F", "F", "F"],
    [3, 10, "F", "F", 0, 0, 0],
    [11, 20, "F", "F", 0, 0, 0],
    [21, 35, 0, 0, 0, 0, 0],
    [36, 40, 0, 1, 0, 0, 0],
    [41, 45, 2, 1, 0, 0, 0],
    [46, 50, 3, 1, 0, 1, 0],
    [51, 55, 4, 2, 1, 1, 0],
    [56, 60, 5, 2, 2, 2, 0],
    [61, 65, 6, 3, 4, 3, "8A"],
    [66, 70, "7A", 4, 5, "4A", "10A"],
    [71, 75, "7A", 5, "5A", "5A", "11B"],
    [76, 80, "8A", 7, "7A", "6B", "12B"],
    [81, 85, "8A", "8A", "7A", "7B", "13B"],
    [86, 90, "9A", "9B", "8B", "8B", "14B"],
    [91, 95, "9A", "9B", "10B", "10B", "15C"],
    [96, 100, "10A", "10B", "11B", "12C", "16C"],
    [101, 105, "10B", "12C", "12C", "14C", "18C"],
    [106, 110, "11B", "12C", "13C", "16C", "20C"],
    [111, 115, "12B", "13C", "14C", "15D", "22D"],
    [116, 120, "12C", "14C", "15C", "18D", "24D"],
    [121, 125, "13C", "15C", "16D", "22D", "26E"],
    [126, 130, "13C", "15D", "17D", "24E", "28E"],
    [131, 135, "14C", "16D", "17D", "24E", "28E"],
    [136, 140, "14D", "16D", "18E", "26E", "30E"],
    [141, 145, "17D", "22E", "23E", "31E", "36E"],
    [146, 150, "18E", "22E", "25E", "30E", "36E"]
];

// AT-8: Ball Spells Attack Table
MERP.AT8 = [
    [1, 4, "F", "F", "F", "F", "F"],
    [5, 8, "F", "F", "F", "F", "F"],
    [9, 12, 0, 0, 0, 0, 1],
    [13, 16, 0, 0, 0, 0, 2],
    [17, 20, 1, 0, 0, 0, 3],
    [21, 24, 2, 1, 0, 0, 4],
    [25, 28, 3, 2, 1, 0, "5A"],
    [29, 32, 4, 3, 2, 0, "6A"],
    [33, 36, "5A", 4, 3, 1, "7A"],
    [37, 40, "6A", "5A", 4, 2, "8A"],
    [41, 44, "7A", "6A", "5A", 3, "9A"],
    [45, 48, "8A", "7A", "6A", 4, "10B"],
    [49, 52, "9A", "8A", "7A", 5, "11B"],
    [53, 56, "10B", "9A", "8A", "6A", "12B"],
    [57, 60, "11B", "10B", "9A", "7A", "13B"],
    [61, 64, "12B", "11B", "10B", "8A", "14B"],
    [65, 68, "12B", "11B", "10B", "9A", "15C"],
    [69, 72, "13B", "12B", "11B", "10A", "16C"],
    [73, 76, "13C", "12B", "11B", "10A", "17C"],
    [77, 80, "14C", "13C", "12C", "11B", "18C"],
    [81, 84, "14C", "13C", "12C", "11B", "19C"],
    [85, 88, "15C", "14C", "13C", "12B", "20C"],
    [89, 92, "15C", "14C", "13C", "12B", "21C"],
    [93, 96, "16C", "15C", "14C", "13C", "22C"],
    [97, 99, "19D", "18D", "17D", "16D", "28D"],
    [100, 100, "22E", "21E", "20E", "19E", "34E"]
];

// AT-9: Base Spells Attack Table (result is RR modifier)
MERP.AT9 = [
    [1, 2, "F", "F", "F", "F"],  // UM
    [3, 4, "F", "F", "F", "F"],
    [5, 8, "F", "F", 70, null],
    [9, 12, "F", "F", 65, null],
    [13, 16, "F", 45, 60, null],
    [17, 20, 45, 40, 50, null],
    [21, 24, 40, 35, 45, null],
    [25, 28, 35, 30, 35, null],
    [29, 32, 30, 25, 30, null],
    [33, 36, 25, 20, 20, null],
    [37, 40, 20, 15, 15, null],
    [41, 44, 15, 10, 5, null],
    [45, 48, 10, 5, 0, null],
    [49, 52, 5, 0, 0, null],
    [53, 56, 0, 0, -5, null],
    [57, 60, 0, -5, -10, null],
    [61, 64, -5, -5, -15, null],
    [65, 68, -5, -10, -20, null],
    [69, 72, -10, -15, -25, null],
    [73, 76, -25, -20, -30, null],
    [77, 80, -30, -25, -35, null],
    [81, 84, -35, -30, -40, null],
    [85, 88, -40, -35, -45, null],
    [89, 92, -45, -40, -50, null],
    [93, 96, -50, -45, -55, null],
    [97, 99, -65, -65, -65, null],  // UM
    [100, 100, -90, -90, -90, null]  // UM
];

// ============================================================
// ATTACK TABLE LOOKUP FUNCTION
// ============================================================
MERP.lookupAttackTable = function(tableName, roll, armorIndex) {
    const table = MERP[tableName];
    if (!table) return { hits: 0, crit: null, fumble: false, error: "Unknown table" };

    for (const row of table) {
        if (roll >= row[0] && roll <= row[1]) {
            const val = row[armorIndex + 2]; // +2 because first two elements are min/max roll
            return MERP.parseAttackResult(val);
        }
    }
    // If roll exceeds table, use last row
    if (roll > table[table.length - 1][1]) {
        const lastRow = table[table.length - 1];
        return MERP.parseAttackResult(lastRow[armorIndex + 2]);
    }
    // If roll is below table minimum (e.g., extreme low open-ended), use first row
    if (roll < table[0][0]) {
        return MERP.parseAttackResult(table[0][armorIndex + 2]);
    }
    return { hits: 0, crit: null, fumble: false };
};

// Map weapon category to attack table
MERP.weaponToAttackTable = {
    "weaponEdged": "AT1",
    "weaponConcussion": "AT2",
    "weapon2H": "AT3",
    "weaponPolearm": "AT3",
    "weaponThrown": "AT4",
    "weaponMissile": "AT4"
};

// ============================================================
// COMBAT MODIFICATIONS
// ============================================================
MERP.combatMods = {
    flank: 15,
    rear: 20,
    surprised: 20,
    stunnedOrDown: 20,
    drawingWeapon: -30,
    halfHitsTaken: -20,
    perTenFeetMoved: -10
};
